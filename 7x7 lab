<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7x7 Lab - 像素文字生成器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        body {
            background-color: #121212;
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        h1 {
            font-size: 2.5rem;
            color: #fff;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }
        
        .subtitle {
            color: #aaa;
            font-size: 1.1rem;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .control-panel {
            flex: 1;
            min-width: 300px;
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.05);
        }
        
        .preview-container {
            flex: 2;
            min-width: 400px;
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.05);
        }
        
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #fff;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input, select, button {
            width: 100%;
            padding: 10px;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 5px;
            color: #fff;
            font-size: 1rem;
        }
        
        button {
            background-color: #3a3a3a;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
            margin-top: 5px;
        }
        
        button:hover {
            background-color: #4a4a4a;
        }
        
        .button-primary {
            background-color: #4CAF50;
        }
        
        .button-primary:hover {
            background-color: #3d8b40;
        }
        
        .preview-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .pixel-preview-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: nowrap;
            gap: 10px;
            max-width: 100%;
            padding: 5px;
        }
        
        .char-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
        }
        
        .char-preview p {
            margin-top: 8px;
            font-size: 0.9rem;
            color: #888;
        }
        
        .pixel-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(7, 1fr);
            gap: 1px;
        }
        
        .pixel-cell {
            border-radius: 1px;
            background-color: #333;
            transition: background-color 0.2s;
        }
        
        .pixel-cell.active {
            background-color: #4CAF50;
        }
        
        .empty-message {
            font-size: 1.2rem;
            color: #666;
            text-align: center;
            padding: 20px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .char-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        .copy-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: 600;
        }
        
        .error-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f44336;
            color: white;
            padding: 12px 24px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: 600;
            max-width: 400px;
            text-align: center;
        }
        
        .copy-message.show, .error-message.show {
            opacity: 1;
        }
        
        .save-load-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .button-secondary {
            background-color: #2196F3;
        }
        
        .button-secondary:hover {
            background-color: #0b7dda;
        }
        
        .button-warning {
            background-color: #ff9800;
        }
        
        .button-warning:hover {
            background-color: #e68900;
        }
        
        .supported-chars {
            background-color: #2d2d2d;
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .supported-chars span {
            color: #4CAF50;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .control-panel, .preview-container {
                min-width: 100%;
            }
            
            .action-buttons, .save-load-buttons {
                grid-template-columns: 1fr;
            }
            
            .pixel-preview-container {
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>7x7 lab</h1>
            <p class="subtitle">像素文字 G-code 生成器 - 可直接3D列印版本</p>
        </header>
        
        <div class="main-content">
            <div class="control-panel">
                <h2 class="section-title">控制面板</h2>
                
                <div class="input-group">
                    <label for="textInput">輸入文字 (支援大小寫字母、數字、空格和一些符號):</label>
                    <input type="text" id="textInput" maxlength="20" placeholder="例如: Hello World 123" value="HELLO">
                    <div class="supported-chars">
                        支援字元: <span>A-Z a-z 0-9 空格 ! ? - = + * / ( ) [ ] { } & @ # $ % ^ &lt; &gt;</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>快速範例:</label>
                    <div class="char-buttons">
                        <button data-char="HELLO">HELLO</button>
                        <button data-char="Hello">Hello</button>
                        <button data-char="NFU">NFU</button>
                        <button data-char="ABC">ABC</button>
                        <button data-char="123">123</button>
                        <button data-char="3D PRINT">3D PRINT</button>
                        <button data-char="Lab">Lab</button>
                        <button data-char="Source">Source</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="pixelSize">像素尺寸 (mm):</label>
                    <input type="number" id="pixelSize" value="5.0" min="1" max="20" step="0.5">
                </div>
                
                <div class="input-group">
                    <label for="blockHeight">厚度 (mm):</label>
                    <input type="number" id="blockHeight" value="2.0" min="0.5" max="10" step="0.5">
                </div>
                
                <div class="input-group">
                    <label for="printStyle">列印樣式:</label>
                    <select id="printStyle">
                        <option value="solid">實心</option>
                        <option value="hollow">空心</option>
                    </select>
                </div>
                
                <div class="action-buttons">
                    <button id="copyBtn" class="button-primary">複製 G-code</button>
                    <button id="downloadBtn" class="button-primary">下載 G-code</button>
                </div>
                
                <div class="save-load-buttons">
                    <button id="saveBtn" class="button-secondary">儲存設定</button>
                    <button id="loadBtn" class="button-warning">載入設定</button>
                </div>
                
                <div class="input-group">
                    <label>G-code 參數 (固定值):</label>
                    <div style="background-color: #2d2d2d; padding: 10px; border-radius: 5px; margin-top: 5px;">
                        <div style="margin-bottom: 5px;">噴嘴直徑: 0.4mm</div>
                        <div style="margin-bottom: 5px;">線材直徑: 1.75mm</div>
                        <div style="margin-bottom: 5px;">層高: 0.2mm</div>
                        <div style="margin-bottom: 5px;">第一層高度: 0.3mm</div>
                        <div>回抽距離: 1.0mm</div>
                    </div>
                </div>
            </div>
            
            <div class="preview-container">
                <h2 class="section-title">字型預覽</h2>
                <div class="preview-area">
                    <div class="pixel-preview-container" id="pixelPreview">
                        <div class="empty-message">輸入文字以顯示預覽</div>
                    </div>
                </div>
                <p style="text-align: center; color: #aaa; font-size: 0.9rem; margin-top: 10px;">
                    每個字元顯示為 7x7 像素方塊，綠色方塊表示需要列印的部分
                </p>
            </div>
        </div>
    </div>

    <!-- 複製成功提示訊息 -->
    <div id="copyMessage" class="copy-message">G-code 已複製到剪貼簿！</div>
    
    <!-- 錯誤提示訊息 -->
    <div id="errorMessage" class="error-message">錯誤訊息</div>

    <script>
        // 完整的字元定義 (7x7 像素) - 大寫字母
        const charMap = {
            'A': [
                [0,0,1,1,1,0,0],
                [0,1,0,0,0,1,0],
                [1,0,0,0,0,0,1],
                [1,1,1,1,1,1,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1]
            ],
            'B': [
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,1,1,1,1,1,0]
            ],
            'C': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            'D': [
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,1,1,1,1,1,0]
            ],
            'E': [
                [1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,1,1]
            ],
            'F': [
                [1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0]
            ],
            'G': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,0],
                [1,0,0,1,1,1,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            'H': [
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,1,1,1,1,1,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1]
            ],
            'I': [
                [1,1,1,1,1,1,1],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [1,1,1,1,1,1,1]
            ],
            'J': [
                [0,0,0,0,0,0,1],
                [0,0,0,0,0,0,1],
                [0,0,0,0,0,0,1],
                [0,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            'K': [
                [1,0,0,0,0,1,0],
                [1,0,0,0,1,0,0],
                [1,0,0,1,0,0,0],
                [1,1,1,0,0,0,0],
                [1,0,0,1,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,0,1,0]
            ],
            'L': [
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,1,1]
            ],
            'M': [
                [1,0,0,0,0,0,1],
                [1,1,0,0,0,1,1],
                [1,0,1,0,1,0,1],
                [1,0,0,1,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1]
            ],
            'N': [
                [1,0,0,0,0,0,1],
                [1,1,0,0,0,0,1],
                [1,0,1,0,0,0,1],
                [1,0,0,1,0,0,1],
                [1,0,0,0,1,0,1],
                [1,0,0,0,0,1,1],
                [1,0,0,0,0,0,1]
            ],
            'O': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            'P': [
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0]
            ],
            'Q': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,1,0,0,1],
                [1,0,0,0,1,0,1],
                [0,1,1,1,1,1,1]
            ],
            'R': [
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,1,1,1,1,1,0],
                [1,0,0,1,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,0,1,0]
            ],
            'S': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,0],
                [0,1,1,1,1,1,0],
                [0,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            'T': [
                [1,1,1,1,1,1,1],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0]
            ],
            'U': [
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            'V': [
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,0,0,0,1,0],
                [0,0,1,0,1,0,0],
                [0,0,0,1,0,0,0]
            ],
            'W': [
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,1,0,0,1],
                [1,0,1,0,1,0,1],
                [1,1,0,0,0,1,1],
                [1,0,0,0,0,0,1]
            ],
            'X': [
                [1,0,0,0,0,0,1],
                [0,1,0,0,0,1,0],
                [0,0,1,0,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,1,0,1,0,0],
                [0,1,0,0,0,1,0],
                [1,0,0,0,0,0,1]
            ],
            'Y': [
                [1,0,0,0,0,0,1],
                [0,1,0,0,0,1,0],
                [0,0,1,0,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0]
            ],
            'Z': [
                [1,1,1,1,1,1,1],
                [0,0,0,0,0,1,0],
                [0,0,0,0,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,0,0,0,0,0],
                [1,1,1,1,1,1,1]
            ],
            '0': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,1,0,1],
                [1,0,0,1,0,0,1],
                [1,0,1,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            '1': [
                [0,0,0,1,0,0,0],
                [0,0,1,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,1,1,1,1,1,0]
            ],
            '2': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [0,0,0,0,0,0,1],
                [0,0,0,1,1,1,0],
                [0,1,1,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,1,1]
            ],
            '3': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [0,0,0,0,0,0,1],
                [0,0,1,1,1,1,0],
                [0,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            '4': [
                [0,0,0,0,1,0,0],
                [0,0,0,1,1,0,0],
                [0,0,1,0,1,0,0],
                [0,1,0,0,1,0,0],
                [1,1,1,1,1,1,1],
                [0,0,0,0,1,0,0],
                [0,0,0,0,1,0,0]
            ],
            '5': [
                [1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,1,0],
                [0,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            '6': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            '7': [
                [1,1,1,1,1,1,1],
                [0,0,0,0,0,0,1],
                [0,0,0,0,0,1,0],
                [0,0,0,0,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0]
            ],
            '8': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            '9': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,1],
                [0,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            // 小寫字母
            'a': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,1,1,1,1,0,0],
                [0,0,0,0,0,1,0],
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,1,0],
                [0,1,1,1,1,1,0]
            ],
            'b': [
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,0,0],
                [1,0,0,0,0,1,0],
                [1,0,0,0,0,1,0],
                [1,1,1,1,1,0,0]
            ],
            'c': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,1,1,1,1,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,1,0],
                [0,1,1,1,1,0,0]
            ],
            'd': [
                [0,0,0,0,0,1,0],
                [0,0,0,0,0,1,0],
                [0,0,0,0,0,1,0],
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,1,0],
                [1,0,0,0,0,1,0],
                [0,1,1,1,1,1,0]
            ],
            'e': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,1,1,1,1,0,0],
                [1,0,0,0,0,1,0],
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,0],
                [0,1,1,1,1,0,0]
            ],
            'f': [
                [0,0,1,1,1,0,0],
                [0,1,0,0,0,1,0],
                [0,1,0,0,0,0,0],
                [1,1,1,1,0,0,0],
                [0,1,0,0,0,0,0],
                [0,1,0,0,0,0,0],
                [0,1,0,0,0,0,0]
            ],
            'g': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,1,0],
                [0,1,1,1,1,1,0],
                [0,0,0,0,0,1,0],
                [1,1,1,1,1,0,0]
            ],
            'h': [
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,0,0],
                [1,0,0,0,0,1,0],
                [1,0,0,0,0,1,0],
                [1,0,0,0,0,1,0]
            ],
            'i': [
                [0,0,1,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,1,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,1,1,0,0,0]
            ],
            'j': [
                [0,0,0,1,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,1,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [1,0,0,1,0,0,0],
                [0,1,1,0,0,0,0]
            ],
            'k': [
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,1,0,0,0],
                [1,1,1,0,0,0,0],
                [1,0,0,1,0,0,0],
                [1,0,0,0,1,0,0]
            ],
            'l': [
                [0,1,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,1,1,0,0,0]
            ],
            'm': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,1,0,1,0,0,0],
                [1,0,1,0,1,0,0],
                [1,0,1,0,1,0,0],
                [1,0,1,0,1,0,0],
                [1,0,1,0,1,0,0]
            ],
            'n': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,1,1,1,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0]
            ],
            'o': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,1,1,1,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [0,1,1,1,0,0,0]
            ],
            'p': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,1,1,1,0,0,0],
                [1,0,0,0,1,0,0],
                [1,1,1,1,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0]
            ],
            'q': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,1,1,1,1,0,0],
                [1,0,0,0,1,0,0],
                [0,1,1,1,1,0,0],
                [0,0,0,0,1,0,0],
                [0,0,0,0,1,0,0]
            ],
            'r': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,0,1,1,0,0,0],
                [1,1,0,0,1,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0]
            ],
            's': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,1,1,1,1,0,0],
                [1,0,0,0,0,0,0],
                [0,1,1,1,0,0,0],
                [0,0,0,0,1,0,0],
                [1,1,1,1,0,0,0]
            ],
            't': [
                [0,1,0,0,0,0,0],
                [0,1,0,0,0,0,0],
                [1,1,1,1,0,0,0],
                [0,1,0,0,0,0,0],
                [0,1,0,0,0,0,0],
                [0,1,0,0,1,0,0],
                [0,0,1,1,0,0,0]
            ],
            'u': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [0,1,1,1,1,0,0]
            ],
            'v': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [0,1,0,1,0,0,0],
                [0,0,1,0,0,0,0]
            ],
            'w': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [1,0,1,0,1,0,0],
                [1,0,1,0,1,0,0],
                [0,1,0,1,0,0,0]
            ],
            'x': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,0,0,0,1,0,0],
                [0,1,0,1,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,0,1,0,0,0],
                [1,0,0,0,1,0,0]
            ],
            'y': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [0,1,1,1,1,0,0],
                [0,0,0,0,1,0,0],
                [1,1,1,1,0,0,0]
            ],
            'z': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,1,1,1,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,0,0,0,0,0],
                [1,1,1,1,1,0,0]
            ],
            // 特殊符號
            '!': [
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0]
            ],
            '?': [
                [0,1,1,1,1,0,0],
                [1,0,0,0,0,1,0],
                [0,0,0,0,0,1,0],
                [0,0,0,1,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,1,0,0,0]
            ],
            '-': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,1,1,1,1,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0]
            ],
            '=': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,1,1,1,1,0,0],
                [0,0,0,0,0,0,0],
                [1,1,1,1,1,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0]
            ],
            '+': [
                [0,0,0,0,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [1,1,1,1,1,1,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,0,0,0,0]
            ],
            '*': [
                [0,0,0,0,0,0,0],
                [0,0,1,0,1,0,0],
                [0,0,0,1,0,0,0],
                [1,1,1,1,1,1,0],
                [0,0,0,1,0,0,0],
                [0,0,1,0,1,0,0],
                [0,0,0,0,0,0,0]
            ],
            '/': [
                [0,0,0,0,0,1,0],
                [0,0,0,0,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [0,0,0,0,0,0,0]
            ],
            '(': [
                [0,0,0,1,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,0,0,0,0,0],
                [0,1,0,0,0,0,0],
                [0,1,0,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,0,1,0,0,0]
            ],
            ')': [
                [0,0,0,1,0,0,0],
                [0,0,0,0,1,0,0],
                [0,0,0,0,0,1,0],
                [0,0,0,0,0,1,0],
                [0,0,0,0,0,1,0],
                [0,0,0,0,1,0,0],
                [0,0,0,1,0,0,0]
            ],
            '[': [
                [0,1,1,1,0,0,0],
                [0,1,0,0,0,0,0],
                [0,1,0,0,0,0,0],
                [0,1,0,0,0,0,0],
                [0,1,0,0,0,0,0],
                [0,1,0,0,0,0,0],
                [0,1,1,1,0,0,0]
            ],
            ']': [
                [0,1,1,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,1,1,1,0,0,0]
            ],
            '{': [
                [0,0,0,1,1,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,0,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,0,1,1,0,0]
            ],
            '}': [
                [0,1,1,0,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,0,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,1,1,0,0,0,0]
            ],
            '&': [
                [0,1,1,0,0,0,0],
                [1,0,0,1,0,0,0],
                [1,0,0,1,0,0,0],
                [0,1,1,0,0,0,0],
                [1,0,0,1,0,0,0],
                [1,0,0,1,0,0,0],
                [0,1,1,0,0,1,0]
            ],
            '@': [
                [0,1,1,1,1,0,0],
                [1,0,0,0,0,1,0],
                [1,0,0,1,1,1,0],
                [1,0,1,0,0,1,0],
                [1,0,1,0,0,1,0],
                [1,0,0,1,1,1,0],
                [0,1,1,1,0,0,0]
            ],
            '#': [
                [0,0,1,0,1,0,0],
                [0,0,1,0,1,0,0],
                [1,1,1,1,1,1,0],
                [0,0,1,0,1,0,0],
                [1,1,1,1,1,1,0],
                [0,0,1,0,1,0,0],
                [0,0,1,0,1,0,0]
            ],
            '$': [
                [0,0,1,0,0,0,0],
                [0,1,1,1,1,0,0],
                [1,0,0,0,0,0,0],
                [0,1,1,1,0,0,0],
                [0,0,0,0,1,0,0],
                [1,1,1,1,0,0,0],
                [0,0,1,0,0,0,0]
            ],
            '%': [
                [1,1,0,0,0,1,0],
                [1,1,0,0,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,0,0,1,1,0],
                [1,0,0,0,1,1,0],
                [0,0,0,0,0,0,0]
            ],
            '^': [
                [0,0,0,1,0,0,0],
                [0,0,1,0,1,0,0],
                [0,1,0,0,0,1,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0]
            ],
            '<': [
                [0,0,0,0,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,0,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,0,1,0,0]
            ],
            '>': [
                [0,0,1,0,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,0,1,0,0],
                [0,0,0,0,0,1,0],
                [0,0,0,0,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,1,0,0,0,0]
            ],
            ' ': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0]
            ]
        };

        // 防抖計時器
        let debounceTimer;
        
        // 顯示字型預覽 (使用防抖技術)
        function showFontPreview() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const text = document.getElementById('textInput').value;
                const previewContainer = document.getElementById('pixelPreview');
                const previewArea = document.querySelector('.preview-area');
                
                if (!text || text.trim() === '') {
                    previewContainer.innerHTML = '<div class="empty-message">輸入文字以顯示預覽</div>';
                    previewContainer.style.width = 'auto';
                    return;
                }
                
                previewContainer.innerHTML = '';
                
                const previewWidth = previewArea.clientWidth - 40;
                const charCount = text.length;
                const charSpacing = 10;
                const maxPixelSize = 30;
                const minPixelSize = 8;
                
                const requiredSpacing = (charCount - 1) * charSpacing;
                let pixelSize = Math.floor((previewWidth - requiredSpacing - 10) / (charCount * 7));
                pixelSize = Math.max(minPixelSize, Math.min(maxPixelSize, pixelSize));
                
                for (let charIndex = 0; charIndex < text.length; charIndex++) {
                    const char = text[charIndex];
                    
                    const charContainer = document.createElement('div');
                    charContainer.className = 'char-preview';
                    charContainer.style.marginRight = charIndex < text.length - 1 ? `${charSpacing}px` : '0';
                    
                    const pixelGrid = document.createElement('div');
                    pixelGrid.className = 'pixel-grid';
                    pixelGrid.style.gridTemplateColumns = `repeat(7, ${pixelSize}px)`;
                    pixelGrid.style.gridTemplateRows = `repeat(7, ${pixelSize}px)`;
                    pixelGrid.style.gap = '1px';
                    
                    // 檢查字元是否支援
                    const charKey = char.toUpperCase() === char && char.toLowerCase() !== char ? 
                                   char.toUpperCase() : char;
                    
                    if (charMap[charKey]) {
                        for (let row = 0; row < 7; row++) {
                            for (let col = 0; col < 7; col++) {
                                const pixelCell = document.createElement('div');
                                pixelCell.className = 'pixel-cell';
                                pixelCell.style.width = `${pixelSize}px`;
                                pixelCell.style.height = `${pixelSize}px`;
                                
                                if (charMap[charKey][row][col] === 1) {
                                    pixelCell.classList.add('active');
                                }
                                
                                pixelGrid.appendChild(pixelCell);
                            }
                        }
                    } else {
                        // 如果是未定義字元，顯示空白網格
                        for (let i = 0; i < 49; i++) {
                            const pixelCell = document.createElement('div');
                            pixelCell.className = 'pixel-cell';
                            pixelCell.style.width = `${pixelSize}px`;
                            pixelCell.style.height = `${pixelSize}px`;
                            pixelGrid.appendChild(pixelCell);
                        }
                    }
                    
                    charContainer.appendChild(pixelGrid);
                    
                    const charLabel = document.createElement('p');
                    charLabel.textContent = `"${char}"`;
                    charContainer.appendChild(charLabel);
                    
                    previewContainer.appendChild(charContainer);
                }
                
                const totalWidth = (charCount * 7 * pixelSize) + requiredSpacing;
                previewContainer.style.width = `${Math.min(totalWidth, previewWidth - 10)}px`;
            }, 300); // 防抖延遲300ms
        }

        // 顯示錯誤訊息
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.classList.add('show');
            setTimeout(() => {
                errorElement.classList.remove('show');
            }, 5000);
        }

        // 顯示複製成功訊息
        function showCopyMessage() {
            const message = document.getElementById('copyMessage');
            message.classList.add('show');
            setTimeout(() => {
                message.classList.remove('show');
            }, 3000);
        }

        // 輸入驗證
        function validateInputs() {
            const text = document.getElementById('textInput').value;
            const pixelSize = parseFloat(document.getElementById('pixelSize').value);
            const blockHeight = parseFloat(document.getElementById('blockHeight').value);
            
            // 檢查文字輸入
            if (!text.trim()) {
                showError('請輸入文字內容');
                return false;
            }
            
            // 檢查文字長度
            if (text.length > 20) {
                showError('文字長度不能超過20個字元');
                return false;
            }
            
            // 檢查是否有不支援的字元
            const unsupportedChars = [];
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const charKey = char.toUpperCase() === char && char.toLowerCase() !== char ? 
                              char.toUpperCase() : char;
                
                if (!charMap[charKey] && char !== ' ') {
                    unsupportedChars.push(char);
                }
            }
            
            if (unsupportedChars.length > 0) {
                showError(`不支援的字元: ${unsupportedChars.join(', ')}`);
                return false;
            }
            
            // 檢查像素尺寸
            if (isNaN(pixelSize) || pixelSize < 1 || pixelSize > 20) {
                showError('像素尺寸必須在1-20mm之間');
                return false;
            }
            
            // 檢查厚度
            if (isNaN(blockHeight) || blockHeight < 0.5 || blockHeight > 10) {
                showError('厚度必須在0.5-10mm之間');
                return false;
            }
            
            return true;
        }

        // 儲存設定到localStorage
        function saveSettings() {
            const settings = {
                text: document.getElementById('textInput').value,
                pixelSize: document.getElementById('pixelSize').value,
                blockHeight: document.getElementById('blockHeight').value,
                printStyle: document.getElementById('printStyle').value
            };
            
            try {
                localStorage.setItem('7x7lab_settings', JSON.stringify(settings));
                showCopyMessage(); // 使用相同的樣式顯示成功訊息
                document.getElementById('copyMessage').textContent = '設定已儲存！';
            } catch (e) {
                showError('無法儲存設定: ' + e.message);
            }
        }

        // 從localStorage載入設定
        function loadSettings() {
            try {
                const saved = localStorage.getItem('7x7lab_settings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    
                    document.getElementById('textInput').value = settings.text || '';
                    document.getElementById('pixelSize').value = settings.pixelSize || 5.0;
                    document.getElementById('blockHeight').value = settings.blockHeight || 2.0;
                    document.getElementById('printStyle').value = settings.printStyle || 'solid';
                    
                    // 更新預覽
                    showFontPreview();
                    
                    showCopyMessage(); // 使用相同的樣式顯示成功訊息
                    document.getElementById('copyMessage').textContent = '設定已載入！';
                } else {
                    showError('沒有儲存的設定');
                }
            } catch (e) {
                showError('無法載入設定: ' + e.message);
            }
        }

        // 生成可直接使用的G-code
        function generateGcode() {
            if (!validateInputs()) {
                return null;
            }
            
            const text = document.getElementById('textInput').value;
            const pixelSize = parseFloat(document.getElementById('pixelSize').value);
            const blockHeight = parseFloat(document.getElementById('blockHeight').value);
            const printStyle = document.getElementById('printStyle').value;
            
            // 固定參數設定（適合多數3D印表機）
            const NOZZLE_DIAMETER = 0.4;        // 噴嘴直徑 mm
            const FILAMENT_DIAMETER = 1.75;     // 線材直徑 mm
            const LAYER_HEIGHT = 0.2;           // 層高 mm
            const FIRST_LAYER_HEIGHT = 0.3;     // 第一層高度 mm
            const LINE_WIDTH = 0.4;             // 線寬 mm
            const PRINT_SPEED = 60;             // 列印速度 mm/s
            const TRAVEL_SPEED = 120;           // 移動速度 mm/s
            const FIRST_LAYER_SPEED = 30;       // 第一層速度 mm/s
            const NOZZLE_TEMP = 210;            // 噴頭溫度 °C (PLA)
            const BED_TEMP = 60;                // 熱床溫度 °C (PLA)
            const RETRACT_DISTANCE = 1.0;       // 回抽距離 mm
            const RETRACT_SPEED = 45;           // 回抽速度 mm/s
            
            // 計算層數
            const totalLayers = Math.ceil(blockHeight / LAYER_HEIGHT);
            const firstLayer = FIRST_LAYER_HEIGHT > 0 ? 1 : 0;
            const normalLayers = totalLayers - firstLayer;
            
            // 計算擠出量函數
            const calculateExtrusion = (length, layerHeight, lineWidth = LINE_WIDTH) => {
                const crossSection = layerHeight * lineWidth;
                const volume = crossSection * length;
                const filamentCrossSection = Math.PI * Math.pow(FILAMENT_DIAMETER / 2, 2);
                return volume / filamentCrossSection;
            };
            
            // 生成G-code頭部
            let gcode = `; 7x7像素文字 - 可直接列印版本
; 文字: ${text}
; 像素尺寸: ${pixelSize}mm
; 厚度: ${blockHeight}mm (${totalLayers}層)
; 列印樣式: ${printStyle === 'solid' ? '實心' : '空心'}
; 噴嘴直徑: ${NOZZLE_DIAMETER}mm
; 線材直徑: ${FILAMENT_DIAMETER}mm
; 層高: ${LAYER_HEIGHT}mm
; 第一層高度: ${FIRST_LAYER_HEIGHT}mm
; 生成時間: ${new Date().toLocaleString()}

; ============ 初始化設定 ============
G21 ; 毫米單位
G90 ; 絕對座標
M82 ; 絕對擠出模式
M140 S${BED_TEMP} ; 設定熱床溫度
M104 S${NOZZLE_TEMP} ; 設定噴頭溫度
M190 S${BED_TEMP} ; 等待熱床達到溫度
M109 S${NOZZLE_TEMP} ; 等待噴頭達到溫度
G28 ; 所有軸歸零
G92 E0 ; 重置擠出機
M83 ; 相對擠出模式（方便計算）

; ============ 清潔噴嘴 ============
G1 Z10 F${TRAVEL_SPEED * 60}
G1 X5 Y5 F${TRAVEL_SPEED * 60}
G1 Z0.2 F${TRAVEL_SPEED * 60}
G1 E3 F60 ; 擠出3mm清理噴嘴
G92 E0 ; 重置擠出機
G1 Z10 F${TRAVEL_SPEED * 60}

; ============ 開始列印 ============

`;
            
            // 計算所有像素的位置
            let pixelPositions = [];
            let xOffset = 20; // 起始X位置
            let yOffset = 20; // 起始Y位置
            
            for (let charIndex = 0; charIndex < text.length; charIndex++) {
                const char = text[charIndex];
                const charKey = char.toUpperCase() === char && char.toLowerCase() !== char ? 
                              char.toUpperCase() : char;
                
                if (charMap[charKey]) {
                    const charX = xOffset;
                    
                    for (let row = 0; row < 7; row++) {
                        for (let col = 0; col < 7; col++) {
                            if (charMap[charKey][row][col] === 1) {
                                const x = charX + col * pixelSize;
                                const y = yOffset + (6 - row) * pixelSize;
                                pixelPositions.push({ x, y });
                            }
                        }
                    }
                    xOffset += 8 * pixelSize; // 字元間距
                }
            }
            
            // 列印第一層
            if (firstLayer > 0) {
                gcode += `; ============ 第一層 ============\n`;
                gcode += `G1 Z${FIRST_LAYER_HEIGHT.toFixed(2)} F${TRAVEL_SPEED * 60}\n`;
                
                for (let i = 0; i < pixelPositions.length; i++) {
                    const pos = pixelPositions[i];
                    
                    // 移動到像素位置
                    gcode += `G1 X${pos.x.toFixed(2)} Y${pos.y.toFixed(2)} F${TRAVEL_SPEED * 60}\n`;
                    
                    // 擠出第一層
                    if (printStyle === 'solid') {
                        // 實心方塊 - 畫輪廓和填充
                        const perimeterLength = pixelSize * 4;
                        const perimeterExtrusion = calculateExtrusion(perimeterLength, FIRST_LAYER_HEIGHT);
                        
                        gcode += `G1 E${perimeterExtrusion.toFixed(4)} F${RETRACT_SPEED * 60}\n`;
                        
                        // 畫外輪廓
                        gcode += `G1 X${(pos.x + pixelSize).toFixed(2)} Y${pos.y.toFixed(2)} E${perimeterExtrusion.toFixed(4)} F${FIRST_LAYER_SPEED * 60}\n`;
                        gcode += `G1 X${(pos.x + pixelSize).toFixed(2)} Y${(pos.y + pixelSize).toFixed(2)} E${perimeterExtrusion.toFixed(4)}\n`;
                        gcode += `G1 X${pos.x.toFixed(2)} Y${(pos.y + pixelSize).toFixed(2)} E${perimeterExtrusion.toFixed(4)}\n`;
                        gcode += `G1 X${pos.x.toFixed(2)} Y${pos.y.toFixed(2)} E${perimeterExtrusion.toFixed(4)}\n`;
                        
                        // 實心填充 - 畫橫線
                        const fillSpacing = 0.4; // 填充線間距
                        const fillLines = Math.floor(pixelSize / fillSpacing);
                        
                        for (let line = 1; line < fillLines; line++) {
                            const fillY = pos.y + line * fillSpacing;
                            const fillLength = pixelSize;
                            const fillExtrusion = calculateExtrusion(fillLength, FIRST_LAYER_HEIGHT);
                            
                            gcode += `G1 X${pos.x.toFixed(2)} Y${fillY.toFixed(2)} E0\n`;
                            gcode += `G1 X${(pos.x + pixelSize).toFixed(2)} Y${fillY.toFixed(2)} E${fillExtrusion.toFixed(4)}\n`;
                        }
                    } else {
                        // 空心方塊 - 只畫輪廓
                        const perimeterLength = pixelSize * 4;
                        const extrusionAmount = calculateExtrusion(perimeterLength, FIRST_LAYER_HEIGHT);
                        
                        gcode += `G1 E${extrusionAmount.toFixed(4)} F${RETRACT_SPEED * 60}\n`;
                        gcode += `G1 X${(pos.x + pixelSize).toFixed(2)} Y${pos.y.toFixed(2)} E${extrusionAmount.toFixed(4)} F${FIRST_LAYER_SPEED * 60}\n`;
                        gcode += `G1 X${(pos.x + pixelSize).toFixed(2)} Y${(pos.y + pixelSize).toFixed(2)} E${extrusionAmount.toFixed(4)}\n`;
                        gcode += `G1 X${pos.x.toFixed(2)} Y${(pos.y + pixelSize).toFixed(2)} E${extrusionAmount.toFixed(4)}\n`;
                        gcode += `G1 X${pos.x.toFixed(2)} Y${pos.y.toFixed(2)} E${extrusionAmount.toFixed(4)}\n`;
                    }
                    
                    // 回抽
                    gcode += `G1 E-${RETRACT_DISTANCE} F${RETRACT_SPEED * 60}\n`;
                    gcode += `G1 Z${(FIRST_LAYER_HEIGHT + 0.5).toFixed(2)} F${TRAVEL_SPEED * 60}\n\n`;
                }
            }
            
            // 列印其餘層
            if (normalLayers > 0) {
                gcode += `; ============ 其他層 (${normalLayers}層) ============\n`;
                
                for (let layer = 1; layer <= normalLayers; layer++) {
                    const currentZ = FIRST_LAYER_HEIGHT + (layer * LAYER_HEIGHT);
                    gcode += `; 第 ${layer + firstLayer} 層, Z=${currentZ.toFixed(2)}mm\n`;
                    
                    for (let i = 0; i < pixelPositions.length; i++) {
                        const pos = pixelPositions[i];
                        
                        // 移動到像素位置
                        gcode += `G1 X${pos.x.toFixed(2)} Y${pos.y.toFixed(2)} Z${(currentZ + 0.5).toFixed(2)} F${TRAVEL_SPEED * 60}\n`;
                        gcode += `G1 Z${currentZ.toFixed(2)} F${TRAVEL_SPEED * 60}\n`;
                        
                        if (printStyle === 'solid') {
                            // 實心方塊 - 畫輪廓和填充
                            const perimeterLength = pixelSize * 4;
                            const perimeterExtrusion = calculateExtrusion(perimeterLength, LAYER_HEIGHT);
                            
                            gcode += `G1 E${RETRACT_DISTANCE} F${RETRACT_SPEED * 60}\n`;
                            
                            // 畫外輪廓
                            gcode += `G1 X${(pos.x + pixelSize).toFixed(2)} Y${pos.y.toFixed(2)} E${perimeterExtrusion.toFixed(4)} F${PRINT_SPEED * 60}\n`;
                            gcode += `G1 X${(pos.x + pixelSize).toFixed(2)} Y${(pos.y + pixelSize).toFixed(2)} E${perimeterExtrusion.toFixed(4)}\n`;
                            gcode += `G1 X${pos.x.toFixed(2)} Y${(pos.y + pixelSize).toFixed(2)} E${perimeterExtrusion.toFixed(4)}\n`;
                            gcode += `G1 X${pos.x.toFixed(2)} Y${pos.y.toFixed(2)} E${perimeterExtrusion.toFixed(4)}\n`;
                            
                            // 實心填充 - 畫橫線
                            const fillSpacing = 0.4; // 填充線間距
                            const fillLines = Math.floor(pixelSize / fillSpacing);
                            
                            for (let line = 1; line < fillLines; line++) {
                                const fillY = pos.y + line * fillSpacing;
                                const fillLength = pixelSize;
                                const fillExtrusion = calculateExtrusion(fillLength, LAYER_HEIGHT);
                                
                                gcode += `G1 X${pos.x.toFixed(2)} Y${fillY.toFixed(2)} E0\n`;
                                gcode += `G1 X${(pos.x + pixelSize).toFixed(2)} Y${fillY.toFixed(2)} E${fillExtrusion.toFixed(4)}\n`;
                            }
                        } else {
                            // 空心方塊 - 只畫輪廓
                            const perimeterLength = pixelSize * 4;
                            const extrusionAmount = calculateExtrusion(perimeterLength, LAYER_HEIGHT);
                            
                            gcode += `G1 E${RETRACT_DISTANCE} F${RETRACT_SPEED * 60}\n`;
                            gcode += `G1 X${(pos.x + pixelSize).toFixed(2)} Y${pos.y.toFixed(2)} E${extrusionAmount.toFixed(4)} F${PRINT_SPEED * 60}\n`;
                            gcode += `G1 X${(pos.x + pixelSize).toFixed(2)} Y${(pos.y + pixelSize).toFixed(2)} E${extrusionAmount.toFixed(4)}\n`;
                            gcode += `G1 X${pos.x.toFixed(2)} Y${(pos.y + pixelSize).toFixed(2)} E${extrusionAmount.toFixed(4)}\n`;
                            gcode += `G1 X${pos.x.toFixed(2)} Y${pos.y.toFixed(2)} E${extrusionAmount.toFixed(4)}\n`;
                        }
                        
                        // 回抽
                        gcode += `G1 E-${RETRACT_DISTANCE} F${RETRACT_SPEED * 60}\n`;
                        gcode += `G1 Z${(currentZ + 0.5).toFixed(2)} F${TRAVEL_SPEED * 60}\n\n`;
                    }
                }
            }
            
            // 列印完成
            gcode += `; ============ 列印完成 ============
G1 Z20 F${TRAVEL_SPEED * 60} ; 抬升噴頭
G28 X Y ; X/Y軸歸零
M104 S0 ; 關閉噴頭加熱
M140 S0 ; 關閉熱床加熱
M107 ; 關閉風扇
M84 ; 關閉步進馬達
M30 ; 程式結束
`;
            
            return gcode;
        }

        // 複製 G-code 到剪貼簿
        function copyGcode() {
            if (!validateInputs()) {
                return;
            }
            
            const gcode = generateGcode();
            if (!gcode) return;
            
            // 使用Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(gcode)
                    .then(() => {
                        showCopyMessage();
                        document.getElementById('copyMessage').textContent = 'G-code 已複製到剪貼簿！';
                    })
                    .catch(err => {
                        console.error('複製失敗:', err);
                        copyFallback(gcode);
                    });
            } else {
                copyFallback(gcode);
            }
        }

        // 降級複製方法
        function copyFallback(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-999999px';
            textarea.style.top = '-999999px';
            document.body.appendChild(textarea);
            
            textarea.focus();
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopyMessage();
                    document.getElementById('copyMessage').textContent = 'G-code 已複製到剪貼簿！';
                } else {
                    showError('無法複製到剪貼簿，請手動複製生成的G-code');
                }
            } catch (err) {
                console.error('降級複製失敗:', err);
                showError('複製失敗，請手動複製生成的文字');
            }
            
            document.body.removeChild(textarea);
        }

        // 下載 G-code 檔案
        function downloadGcode() {
            if (!validateInputs()) {
                return;
            }
            
            const gcode = generateGcode();
            if (!gcode) return;
            
            const cleanText = document.getElementById('textInput').value.replace(/[^a-zA-Z0-9]/g, '_');
            const blob = new Blob([gcode], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `7x7_pixel_${cleanText}.gcode`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 事件監聽器
            document.getElementById('copyBtn').addEventListener('click', copyGcode);
            document.getElementById('downloadBtn').addEventListener('click', downloadGcode);
            document.getElementById('saveBtn').addEventListener('click', saveSettings);
            document.getElementById('loadBtn').addEventListener('click', loadSettings);
            
            // 快速範例按鈕
            document.querySelectorAll('.char-buttons button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const char = e.target.dataset.char;
                    document.getElementById('textInput').value = char;
                    showFontPreview();
                });
            });
            
            // 輸入變化時更新預覽 (使用防抖)
            document.getElementById('textInput').addEventListener('input', showFontPreview);
            document.getElementById('pixelSize').addEventListener('change', showFontPreview);
            document.getElementById('blockHeight').addEventListener('change', showFontPreview);
            document.getElementById('printStyle').addEventListener('change', showFontPreview);
            
            // 視窗大小變化時重新計算預覽
            window.addEventListener('resize', showFontPreview);
            
            // 嘗試載入儲存的設定
            try {
                const saved = localStorage.getItem('7x7lab_settings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    document.getElementById('textInput').value = settings.text || '';
                    document.getElementById('pixelSize').value = settings.pixelSize || 5.0;
                    document.getElementById('blockHeight').value = settings.blockHeight || 2.0;
                    document.getElementById('printStyle').value = settings.printStyle || 'solid';
                }
            } catch (e) {
                console.log('無法載入設定:', e);
            }
            
            // 初始顯示預覽
            showFontPreview();
        });
    </script>
</body>
</html>
